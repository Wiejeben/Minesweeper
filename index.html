<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Minesweeper</title>
	<style>
		*, *:before, *:after {
			box-sizing: inherit;
		}

		html {
			box-sizing: border-box;
		}

		body {
			font-family: Arial, sans-serif;
		}

		.container {
			max-width: 960px;
			margin: 0 auto;
		}

		#minefield {
			background: #BBB;
			line-height: 0;
			border-spacing: 0;
			user-select: none;
		}

		.minefield-tile {
			padding: 0;
			width: 24px;
			height: 24px;
			background: url(./img/empty.png);
		}

		.minefield-tile__covered {
			background: url(./img/covered.png);
		}
	</style>
</head>
<body>
	<div id="app" class="container">
		<form v-on:submit.prevent="generate">
			<fieldset>
				<legend>Configuration</legend>
				<label for="inputWidth">Width: </label><input type="number" v-model.number="width" id="inputWidth"><br>
				<label for="inputHeight">Height: </label><input type="number" v-model.number="height" id="inputHeight"><br>
				<label for="inputMines">Mines: </label><input type="number" v-model.number="mines" id="inputMines"><br>
				<hr>
				<button type="submit">Submit &amp; reload</button>
				<input type="checkbox" v-model="debug">
			</fieldset>
		</form>

		<table id="minefield" v-if="ready">
			<tbody>
				<tr class="minefield-row" v-for="(row, x) in tiles">
					<td class="minefield-tile" v-for="(tile, y) in row" @click.left="uncoverTile(x, y)" :class="{ 'minefield-tile__covered' : tile.covered }">
						<span v-if="!tile.covered">
							<img :src="'./img/' + getTileImage(tile)" :alt="tile.value" width="24" height="24">
						</span>
					</td>
				</tr>	
			</tbody>
			
		</table>
	</div>

	<script src="https://unpkg.com/vue"></script>
	<script>
		new Vue({
			el: '#app',
			data: {
				ready: false,
				width: 16,
				height: 16,
				mines: 40,
				debug: false,
				minePositions: [],
				tiles: []
			},
			mounted: function() {
				// Render game
				this.generate()
			},

			methods: {
				generate: function() {
					this.ready = false;

					this.minePositions = this.getMinePositions();
					this.generateInitialTiles();
					this.assignTileValues();

					this.ready = true;
				},

				getMinePositions: function() {
					var length = (this.height * this.width);

					var results = []
					while (results.length < this.mines)
					{
					    var number = Math.floor(Math.random() * length);

					    // Skip: already exiss
					    if(results.indexOf(number) > -1) continue;

					    results[results.length] = number;
					}

					return results;
				},

				generateInitialTiles: function() {
					var tiles = [];

					for (var x = 0; x < this.height; x++)
					{
						tiles[x] = [];
						for (var y = 0; y < this.width; y++)
						{
							// covered
							tiles[x][y] = { covered: !this.debug, flagged: false, value: 0 };
						}
					}

					this.tiles = tiles;
				},

				assignTileValues: function() {
					for (var x = 0; x <= this.tiles.length - 1; x++)
					{
						var row = this.tiles[x];

						for (var y = 0; y <= row.length - 1; y++)
						{
							var tile = row[y];
							tile.value = this.getTileValue(x, y);
						}
					}
				},

				getTileIndex: function(x, y) {
					return ((x+1) * (y+1)) - 1
				},

				hasMine(x, y) {
					if (this.isOutsideBounds(x, y)) return false;

					return this.minePositions.indexOf(this.getTileIndex(x, y)) > -1
				},

				hasMineInteger(x, y) {
					if (this.hasMine(x, y))
					{
						return 1
					}

					return 0
				},

				getTileValue: function(x, y) {
					// Current
					if (this.hasMine(x, y)) return -1;

					var value = 0;

					value += this.hasMineInteger(x - 1, y - 1); // Top left
					value += this.hasMineInteger(x - 1, y); 	// Top
					value += this.hasMineInteger(x - 1, y + 1); // Top right
					value += this.hasMineInteger(x, y - 1); 	// Left
					value += this.hasMineInteger(x, y + 1); 	// Right
					value += this.hasMineInteger(x + 1, y - 1); // Bottom left
					value += this.hasMineInteger(x + 1, y); 	// Bottom
					value += this.hasMineInteger(x + 1, y + 1); // Bottom right

					return value;
				},

				getTileImage: function(tile) {
					var value = tile.value;

					if (value == 0) return 'empty.png';
					if (value == -1) return 'mine.png';

					return 'number-' + value + '.png'
				},

				uncoverTile: function(x, y) {
					if (this.tiles[x][y].covered == false) return; // already uncovered

					this.tiles[x][y].covered = false;
					console.log('uncover');

					// Uncover all connected zero tiles
					if (this.getTileValue(x, y) == 0)
					{
						console.log('start uncovering all zeros');
						// this.uncoverAllZeroTiles(x, y)
					}
				},

				uncoverAllZeroTiles: function(x, y) {
					if (this.isOutsideBounds(x, y) || this.getTileValue(x, y) != 0) return;

					this.uncoverTile(x, y); // uncover current zero tile

					console.log('scan');

					// this.uncoverAllZeroTiles(x - 1, y - 1);
					this.uncoverAllZeroTiles(x - 1, y);
					// this.uncoverAllZeroTiles(x - 1, y + 1);
					this.uncoverAllZeroTiles(x, y - 1);
					this.uncoverAllZeroTiles(x, y + 1);
					// this.uncoverAllZeroTiles(x + 1, y - 1);
					this.uncoverAllZeroTiles(x + 1, y);
					// this.uncoverAllZeroTiles(x + 1, y + 1);
				},

				isOutsideBounds: function(x, y) {
					return (x < 0 || x > (this.tiles.length - 1) || y < 0 || y > (this.tiles[0].length - 1))
				}
			}
		})
	</script>
</body>
</html>